<!doctype html>
<html lang="zh-CN">
  <head>
    <title>王者荣耀 - 脱壳及Unity3D脚本提取 // pkiller</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.105.0">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="pkiller" />
    <meta name="description" content="王者荣耀、脱壳、hook并C#脚本提取" />
    <link rel="stylesheet" href="/css/main.min.3c3c186cd62e563ad6e2f00a89dbee656ab912d1d46f856b5605dd0232521e2a.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="王者荣耀 - 脱壳及Unity3D脚本提取"/>
<meta name="twitter:description" content="王者荣耀、脱壳、hook并C#脚本提取"/>

    <meta property="og:title" content="王者荣耀 - 脱壳及Unity3D脚本提取" />
<meta property="og:description" content="王者荣耀、脱壳、hook并C#脚本提取" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://pkiller.com/android/%E7%8E%8B%E8%80%85%E8%8D%A3%E8%80%80-%E8%84%B1%E5%A3%B3%E5%8F%8Aunity3d%E8%84%9A%E6%9C%AC%E6%8F%90%E5%8F%96/" /><meta property="article:section" content="android" />
<meta property="article:published_time" content="2018-04-26T11:07:43+08:00" />
<meta property="article:modified_time" content="2018-04-26T11:07:43+08:00" />



  </head>
  <body>
    <header class="app-header">
      <a href="https://pkiller.com/"><img class="app-header-avatar" src="/images/avatar.png" alt="pkiller" /></a>
      <span class="app-header-title">pkiller</span>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/android">Android</a>
             - 
          
          <a class="app-header-menu-item" href="/iot">IoT</a>
             - 
          
          <a class="app-header-menu-item" href="/other">Other</a>
             - 
          
          <a class="app-header-menu-item" href="/about">Me</a>
             - 
          
          <a class="app-header-menu-item" href="/tags/">Tags</a>
      </nav>
      <p>Android applications, android systems and IoT devices. Specifically on virus analysis, vulnerability research, security architecture design, and security assessments.</p>
      <div class="app-header-social">
        
          <a href="https://github.com/pkilller" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>My Github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">王者荣耀 - 脱壳及Unity3D脚本提取</h1>
      <div class="post-meta">
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Apr 26, 2018
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          3 min read
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="https://pkiller.com/tags/%E7%8E%8B%E8%80%85%E8%8D%A3%E8%80%80/">王者荣耀</a>
              <a class="tag" href="https://pkiller.com/tags/unity3d/">Unity3D</a>
              <a class="tag" href="https://pkiller.com/tags/%E6%B8%B8%E6%88%8F%E8%BE%85%E5%8A%A9/">游戏辅助</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <p>王者荣耀采用流行的Unity3d框架开发，主要游戏逻辑使用C#编写， 但目前尚未确认是否有使用到Lua。</p>
<h2 id="一关于unity3d">一、关于Unity3D</h2>
<p>Unity3D是一款专用于3D游戏开发的跨平台框架，支持Lua、C#、JS脚本语言开发游戏逻辑。但目前使用较为广泛的还是C#，而王者荣耀也不例外。</p>
<h2 id="二unity3d-with-c手游的通用修改方案">二、Unity3D with C#手游的通用修改方案</h2>
<p>先来看下通用的脚本提取方法。Unity3D只是提供3D框架，其对C#脚本的支持能力完全依赖开源项：</p>
<p>mono (<a href="https://github.com/mono/mono">https://github.com/mono/mono</a>, <code>在apk的lib下面有一个名为libmono.so就是使用了mono项目的特征</code>)。</p>
<p><img src="1.png" alt="王者荣耀脚本提取" title="王者荣耀脚本提取"></p>
<p>Unity3D编译好后，最终的C#文件保存在<code>×.apk/assets/bin/Data/Managed/中的Assembly-CSharp.dll</code> 和 <code>Assembly-Csharp-firstpass.dll</code> 两个文件，其都是编译好的C#文件。</p>
<p><img src="2.png" alt="王者荣耀脚本提取" title="王者荣耀脚本提取"></p>
<p>对Unity3D游戏逻辑的修改最后就是针对以上这两个dll文件，<code>这两个dll文件是windows上的PE格式</code></p>
<p><img src="3.png" alt="王者荣耀脚本提取" title="王者荣耀脚本提取"></p>
<p>正常无保护的情况下可以很明显的看出以上两个文件的特征，使用一些C#的反编译工具(如:<code>.Net Reflector、ILSpy</code>)可以很容易的得到源码逻辑：</p>
<p><img src="4.png" alt="王者荣耀脚本提取" title="王者荣耀脚本提取"></p>
<p>最后利用如.NetReflector工具对 dll文件中的游戏逻辑做修改，并替换dll文件后打包。便完成了游戏的修改。</p>
<h2 id="三对王者荣耀进行分析">三、对王者荣耀进行分析</h2>
<p><strong>1. 在王者荣耀中，这两个文件(<code>Assembly-CSharp.dll</code> 和 <code>Assembly-Csharp-firstpass.dll</code>)均被加密保护，已经无法看到标准的PE头。</strong></p>
<p><img src="5.png" alt="王者荣耀脚本提取" title="王者荣耀脚本提取"></p>
<p><strong>2. C#解析引擎libmono.so也被加壳混淆。</strong></p>
<p><img src="6.png" alt="王者荣耀脚本提取" title="王者荣耀脚本提取"></p>
<p><strong>3. 游戏存在反调试保护，无法用断点断到关键函数，会自动退出。</strong></p>
<p>根据阅读mono开源项目得知其的加载assembly文件的方法名为：</p>
<p>mono_image_open_from_data_with_name(<code>char *data, guint32 data_len</code>, gboolean need_copy, MonoImageOpenStatus *status, gboolean refonly, const char *name)</p>
<p>并且该函数在libmono.so中对外导出</p>
<ul>
<li>
<p>第1个参数data, 指向的是Assembly-*.dll的完整文件数据。</p>
</li>
<li>
<p>第2个参数是data_len，是数据长度。</p>
</li>
</ul>
<p>首先查看libmono.so中的<code>mono_image_open_from_data_with_name</code>导出函数，发现已被加密混淆。怀疑TX可能对mono做了特殊的定制(如果是的话会比较棘手)</p>
<p><strong>4. 通过进程注入对libmono.so脱壳还原代码后发现并无特殊定制：</strong></p>
<p>说明调用到<code>mono_image_open_from_data_with_name</code>后参数中的一定是明文dll数据。</p>
<p><img src="7.png" alt="王者荣耀脚本提取" title="王者荣耀脚本提取"></p>
<p>既然没有定制libmono.so，所以直接采用hook方式进行(可使用开源项目adbi、或自己开发)hook这个函数(<code>mono_image_open_from_data_with_name</code>)
但由于Assembly-*.dll文件在游戏启动时就被加载，所以需要考虑hook时机：</p>
<p>1.使用debug模式启动王者荣耀，使其处于等待调试状态&hellip;</p>
<p>2.先hook住libc.so中的__openat函数，当发现有Assembly-*.dll文件被打开时，再对libmono.so中的<code>mono_image_open_from_data_with_name</code>挂钩，这样可以保证hook不错过时机，并且外壳代码已经还原完毕。</p>
<p>3.最后将<code>mono_image_open_from_data_with_name</code> 的数据写出文件。</p>
<p><strong>5. DUMP成功后的脚本，使用反编译工具可以看到游戏逻辑，并可以修改：</strong></p>
<p><img src="8.png" alt="王者荣耀脚本提取" title="王者荣耀脚本提取"></p>
<p>本次分析验证到此。</p>
<h2 id="四基于此开发辅助的思路">四、基于此开发辅助的思路</h2>
<ul>
<li>
<p>定位到游戏关键逻辑后，使用C#反编译修改工具(如:<code>.Net Reflector、ILSpy</code>)对脚本进行修改。</p>
</li>
<li>
<p>在加载脚本时用hook将修改后的脚本替换进去，游戏的逻辑也随之被修改。</p>
</li>
</ul>

    </div>
    <div class="post-footer">
      <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "pkiller" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  </article>

    </main>
  </body>
</html>
