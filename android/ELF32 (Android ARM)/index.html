<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <title>
    ELF32 (Android ARM) // pkiller&#39;s Blog
  </title>

  <link href="http://gmpg.org/xfn/11" rel="profile">
<meta http-equiv="content-type" content="text/html; charset=utf-8">


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="">
<meta name="generator" content="Hugo 0.16-DEV" />

  <meta property="og:title" content="ELF32 (Android ARM)" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:locale" content="en_US" />
<meta property="og:url" content="https://pkiller.com/android/ELF32%20%28Android%20ARM%29/" />


  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/base-min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/pure-min.css">
  
  
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/grids-responsive-min.css">
  
  

  <link rel="stylesheet" href="https://pkiller.com/css/redlounge.css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
  <link href='//fonts.googleapis.com/css?family=Raleway:400,200,100,700,300,500,600,800' rel='stylesheet' type='text/css'>
  <link href='//fonts.googleapis.com/css?family=Libre+Baskerville:400,700,400italic' rel='stylesheet' type='text/css'>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
  <link rel="shortcut icon" type="image/x-icon" href="/img/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="pkiller&#39;s Blog" />

    
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/styles/tomorrow-night-bright.min.css">
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>


  

  

  

  
</head>

<body>
	

	<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
  <div class="header">
    

	
	  <img src="/images/avatar.jpeg" class="sidebarphoto">
	

    <h1 class="brand-title">pkiller</h1>
    <h2 class="brand-tagline">Peanut Killer~</h2>

    <nav class="nav">
      <ul class="nav-list">
        <li class="nav-item"><span class="nav-item-separator">//</span><a href="https://pkiller.com">Home</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/about">About</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/android">Android</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/music">Music</a></li>
        
      </ul>
    </nav>

    
    <div class="social-buttons">
      
        
        <a href="http://www.github.com/pkilller" target="_blank"><i class='fa fa-github'></i></a>
        
      
        
        <a href="http://www.twitter.com/aronkou1" target="_blank"><i class='fa fa-twitter'></i></a>
        
      
      
    </div>
    

  </div>
</div>

	
	

    <div class="content pure-u-1 pure-u-md-3-4">
		<a name="top"></a>
		

		
			
		    <div id="toc" class="pure-u-1 pure-u-md-1-4">
				<small class="toc-label">Contents</small>
		   	 	<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#1-rel-dyn-dt-rel-和-rel-plt-dt-jmprel-的区别:d797541984d2426be471f97863bea3b7">1. <code>.rel.dyn(DT_REL)</code> 和 <code>.rel.plt(DT_JMPREL)</code> 的区别.</a></li>
<li><a href="#2-got-概念-global-offset-table:d797541984d2426be471f97863bea3b7">2. GOT 概念(GLOBAL OFFSET TABLE)</a></li>
<li><a href="#3-hook-导入-导出函数:d797541984d2426be471f97863bea3b7">3. HOOK 导入/导出函数.</a></li>
<li><a href="#4-总结:d797541984d2426be471f97863bea3b7">4. 总结:</a></li>
</ul></li>
</ul>
</nav>
		    </div>
		    
	    
  		<section class="post">
            <h1 class="post-title">
              <a href="/android/ELF32%20%28Android%20ARM%29/">ELF32 (Android ARM)</a>
            </h1>
            <h3 class="post-subtitle">
            	
            </h3>
            
            	<span class="post-date">
                	<span class="post-date-day"><sup>18</sup></span><span class="post-date-separator">/</span><span class="post-date-month">Jun</span> <span class="post-date-year">2016</span>
            	</span>
            	
            
            	
            

			
			

			

			

            

<p>首先勘误： 下图中 用STB_WEAK 来表示导出函数是错误的。</p>

<p><img src="1.png" alt="img" title="img" /></p>

<h2 id="1-rel-dyn-dt-rel-和-rel-plt-dt-jmprel-的区别:d797541984d2426be471f97863bea3b7">1. <code>.rel.dyn(DT_REL)</code> 和 <code>.rel.plt(DT_JMPREL)</code> 的区别.</h2>

<p><strong>在任意位置 使用静态方式 调用导入函数(API)</strong></p>

<p>引用项会出现在.rel.plt(DT_JMPREL)中, TYPE为R_ARM_JUMP_SLOT</p>

<p>例子:</p>

<pre><code>      exit (0);

</code></pre>

<p><strong>在函数内 使用指针方式 调用导入函数(API)</strong></p>

<p>引用项会出现在.rel.dyn(DT_REL)中, TYPE为R_ARM_GLOB_DAT</p>

<p>例子:</p>

<pre><code> void fun(){

    typedef void *(*my_exit )(int);

    my_exit exit_ptr = (my_exit )exit;

    exit_ptr(0);

 }
</code></pre>

<p><strong>在全局 引用导入函数(API)指针</strong></p>

<p>引用项会分别在.rel.dyn(DT_REL)和.rel.plt(DT_JMPREL)中各加入一条:</p>

<p>在.rel.dyn(DT_REL)中加入TYPE为R_ARM_ABS32.</p>

<p>在.rel.plt(DT_JMPREL)中加入TYPE为R_ARM_JUMP_SLOT.</p>

<p>例子:</p>

<pre><code>      void *g_exit = (void*)exit;
</code></pre>

<h2 id="2-got-概念-global-offset-table:d797541984d2426be471f97863bea3b7">2. GOT 概念(GLOBAL OFFSET TABLE)</h2>

<p>module的GOT表被加载时, 会由linker填充该module导入函数的addr. 之后该module中的代码通过GOT中被填充好的地址值来间接调用导入函数.</p>

<p>GOT表无需太关注, 因为GOT中的每一项Elf32_Addr. 都有DT_REL和DT_JMPREL中Elf32_Rel::r_offset对其的指向,被所有Elf32_Rel::r_offset指向形成的这一片连续Elf32_Addr区域就被称为&rdquo;GOT表&rdquo;, 理论上讲所有的Elf32_Rel::r_offset也可以指向不连续的区域(前提是linker不再按照连续地址方式处理. 目前linker中对got表的处理使用了地址连续的方式.).这样在对抗和逆向中就多了一条路径: 通过Elf32_Rel::r_offset来找到对应got项.</p>

<p><strong>DT_PLTGOT与&rdquo;.got&rdquo;</strong></p>

<p>dynamic的DT_PLTGOT处于section的&rdquo;.got&rdquo;范围之中:
        &ldquo;.got&rdquo; :[item,item,&hellip;,DT_PLTGOT[item,item,&hellip;]]</p>

<h2 id="3-hook-导入-导出函数:d797541984d2426be471f97863bea3b7">3. HOOK 导入/导出函数.</h2>

<p>导入函数信息存储于Elf32_Rel结构中, 该结构位于: (program_table::p_type == PT_DYNAMIC)的项下的Elf32_Dyn::d_type == DT_REL(.rel.dyn) 与 DT_JMP_REL(.rel.plt).</p>

<p>Elf32_Rel中保存了导出函数的offset, 和对应的symbol_table_index以及rel_type(类型).  这里的关键是symbol_table_index.</p>

<p>通过hash table把要HOOK的函数名(符号名)转为对应的symbol_table_index, 然后遍历Elf32_Dyn数组中的DT_REL与DT_JMP_REL中找到与之对应的项, 该项中的Elf32_Rel::r_offset中指向了一个sizeof(Elf32_Addr)长度的地址, 该地址存放的正是导入函数的地址. 所以执行如下便可完成hook:</p>

<pre><code> *(Elf32_Addr*)(base + Elf32_Rel::r_offset ) = New_Fun_Ptr ;
</code></pre>

<p><strong>补充:</strong> 以上方法只能HOOK到静态调用, 对于通过dlsym()获取函数指针的调用方法可以通过如下方法:</p>

<pre><code>  修改&quot;导入函数&quot;所在的模块中用于描述该导出函数信息的Elf32_Dym对象, 然后修改其Elf32_Sym::st_value, 这样可以将dlsym()方式一并HOOK. (见下面的&quot;导出函数&quot;HOOK方法)

  要么使用inline hook解决一切麻烦.
</code></pre>

<p>导出函数的offset地址存储在Elf32_Sym::st_value中( Elf32_Sym::st_shndx != SHN_UNDEF 表明该Elf32_Sym存储的是一个导出函数项(android的linker源码中这样处理). 根据实际观察，通常导出函数的st_shndx为8. ), 导出函数所在Elf32_Sym结构的定位与上面导入函数的寻找方式一样, 都是通过hash table. 最后修改方法如:</p>

<pre><code> *(Elf32_Addr*) Elf32_Sym::st_value = New_Fun_Ptr;
</code></pre>

<p><strong>补充:</strong> 以上方法只能在对文件进行HOOK, 因为当自身模块代码运行之前, Elf32_Sym::st_value已经被linker填充到了调用方的GOT表中了. 补充方法有二, 要么HOOK调用方的导入, 要么实施inline hook, 对进程内所有调用都有效.</p>

<h2 id="4-总结:d797541984d2426be471f97863bea3b7">4. 总结:</h2>

<p>此HOOK导入 等于 彼HOOK导出. 具体怎么实施HOOK看发起方是谁.  最后 inline hook 大法好!.</p>

	
			

			

			
				<div class="paging">
					<span class="paging-label">More Reading</span>
					
					<div class="paging-newer">
						<span class="dark-red">Newer</span><span class="decorative-marker">//</span>
						<a class="paging-link" href="/android/ELF%E7%9A%84dump%E5%8F%8A%E4%BF%AE%E5%A4%8D%E6%80%9D%E8%B7%AF/">ELF的DUMP及修复思路</a>
		            </div>
		            

					
					<div class="paging-older">
						<span class="dark-red">Older</span><span class="decorative-marker">//</span>
			            <a class="paging-link" href="/android/Java%E6%B7%B7%E6%B7%86%E6%8A%80%E5%B7%A7-%E5%8F%8D%E6%B7%B7%E6%B7%86-%E5%8A%A0%E5%9B%BA%20%E6%80%BB%E7%BB%93/">Java混淆/反混淆/加固 总结</a>
		            </div>
		            
	            </div>
            
          </section>
          
          	<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'pkiller';
    var disqus_identifier = 'https:\/\/pkiller.com\/android\/ELF32%20%28Android%20ARM%29\/';
    var disqus_title = 'ELF32 (Android ARM)';
    var disqus_url = 'https:\/\/pkiller.com\/android\/ELF32%20%28Android%20ARM%29\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          
        
      <div class="footer">
	<hr class="thin" />
	<div class="pure-menu pure-menu-horizontal pure-menu-open">
		<ul class="footer-menu">
		
			<li><a href="/posts">Blog</a></li>
		
		</ul>
	</div>

	<p>&copy; 2018. All rights reserved.</p>
</div>
    </div>
  </div>
	

	

  
</body>
</html>
