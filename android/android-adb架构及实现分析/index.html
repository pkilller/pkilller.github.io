<!doctype html>
<html lang="zh-CN">
  <head>
    <title>Android Adb 架构及实现分析 // pkiller</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.105.0">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="pkiller" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="/css/main.min.3c3c186cd62e563ad6e2f00a89dbee656ab912d1d46f856b5605dd0232521e2a.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Android Adb 架构及实现分析"/>
<meta name="twitter:description" content="一、基本概念 Adb(Android-Debug-Bridge)是为了方便Host与目标Android设备通讯而出现的一种套件，支持USB与T"/>

    <meta property="og:title" content="Android Adb 架构及实现分析" />
<meta property="og:description" content="一、基本概念 Adb(Android-Debug-Bridge)是为了方便Host与目标Android设备通讯而出现的一种套件，支持USB与T" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://pkiller.com/android/android-adb%E6%9E%B6%E6%9E%84%E5%8F%8A%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90/" /><meta property="article:section" content="android" />
<meta property="article:published_time" content="2018-08-14T23:00:48+08:00" />
<meta property="article:modified_time" content="2018-08-14T23:00:48+08:00" />



  </head>
  <body>
    <header class="app-header">
      <a href="https://pkiller.com/"><img class="app-header-avatar" src="/images/avatar.png" alt="pkiller" /></a>
      <span class="app-header-title">pkiller</span>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/android">Android</a>
             - 
          
          <a class="app-header-menu-item" href="/iot">IoT</a>
             - 
          
          <a class="app-header-menu-item" href="/other">Other</a>
             - 
          
          <a class="app-header-menu-item" href="/about">Me</a>
             - 
          
          <a class="app-header-menu-item" href="/tags/">Tags</a>
      </nav>
      <p>Android applications, android systems and IoT devices. Specifically on virus analysis, vulnerability research, security architecture design, and security assessments.</p>
      <div class="app-header-social">
        
          <a href="https://github.com/pkilller" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>My Github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Android Adb 架构及实现分析</h1>
      <div class="post-meta">
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Aug 14, 2018
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          15 min read
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="https://pkiller.com/tags/android/">android</a>
              <a class="tag" href="https://pkiller.com/tags/adb/">adb</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <h2 id="一基本概念">一、基本概念</h2>
<p>Adb(Android-Debug-Bridge)是为了方便Host与目标Android设备通讯而出现的一种套件，支持USB与TCP/IP的通讯的方式。Adb分为三个端：Client &amp; Server &amp; Mobile。Adb的部分源代码是混在一起的，很多部分的功能可以重用，各端独立的逻辑使用预编译指令来分隔离。源码中通常使用预编译定义<code>ADB_HOST</code>来表示PC上的代码，其他#else块中表示Mobile代码，其他的表示为3端共享的代码。
在本文中我们将adb一共分为三部分，但实际上在Mobile中也包含adb, 即Client和Server端。也就是说可以使用Mobile调试Mobile。但是为了便于理解，不混淆概念故将其简化为Mobile和PC端。实际应当以HOST来表示adb也就是调试人员所使用的机器。源码中也会用<code>HOST_ON_TARGET</code>预编译定义来表示运行在Mobile设备中的adb(Server&amp;Client).</p>
<p><img src="1.png" alt="adb" title="adb"></p>
<p><img src="2.png" alt="adb" title="adb"></p>
<h3 id="a-pc端">A. PC端</h3>
<p>Adb Server 与 Adb Client，二者为同一个binary文件即adb或adb.exe，通过启动参数来区分角色.
Server为Client提供服务的端口为： 5037(PC端) 或 5038(Mobile端).</p>
<h3 id="b-mobile端">B. Mobile端</h3>
<p>Adbd，提供最终的adb命令实现.</p>
<h3 id="c-连接模式">C. 连接模式</h3>
<p>分为两种:</p>
<ul>
<li>USB模式, PC通过USB与Mobile通讯.  模式依据：Mobile中<code>service.adb.tcp.port</code>值为0  (property)</li>
<li>TCP/IP模式, PC通过tcp/ip与Mobile进行通讯.  模式依据：Mobile中<code>service.adb.tcp.port</code>值为port number  (property)</li>
</ul>
<h2 id="二基本用法">二、基本用法</h2>
<h3 id="a-切换为tcpip模式">A. 切换为TCP/IP模式</h3>
<p>切换为TCP/IP模式：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">adb tcpip <span class="m">6666</span>  <span class="c1"># 将当前已连接USB上的Mobile端切换为TCP/IP模式，以6666端口进行监听.</span>
</span></span></code></pre></div><p>切换后，断开USB链接，并使用TCP/IP重新连接设备：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">adb kill-server
</span></span><span class="line"><span class="cl">adb connect 192.168.125.236:6666 
</span></span></code></pre></div><h2 id="三android中相关的property">三、Android中相关的property</h2>
<h3 id="a-adbd是否拥有root权限">A. adbd是否拥有ROOT权限</h3>
<p><code>/xbin/adbd</code>文件拥有s标志位, 所以默认以root权限启动的，启动后会根据Propterty值决定是否降权到SHELL权限。
相关Property:  <code>ro.secure</code> &amp; <code>ro.debuggable</code> &amp; <code>service.adb.root</code></p>
<p><strong>adbd决定是否降权到shell的逻辑：</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp"># 伪代码
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">if</span>  <span class="n">ro</span><span class="p">.</span><span class="n">secure</span><span class="o">==</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ro</span><span class="p">.</span><span class="n">debuggable</span><span class="o">==</span><span class="mi">0</span> <span class="o">||</span> <span class="n">service</span><span class="p">.</span><span class="n">adb</span><span class="p">.</span><span class="n">root</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cp"># drop privileges
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="n">setgid</span><span class="p">(</span><span class="n">AID_SHELL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">setuid</span><span class="p">(</span><span class="n">AID_SHELL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> 
</span></span></code></pre></div><p>以下是源码中判断降权的逻辑：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp"># xref: /system/core/adb/adb.c
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="nf">adb_main</span><span class="p">(</span><span class="kt">int</span> <span class="n">is_daemon</span><span class="p">,</span> <span class="kt">int</span> <span class="n">server_port</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/* don&#39;t listen on a port (default 5037) if running in secure mode */</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* don&#39;t run as root if we are running in secure mode */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">should_drop_privileges</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">drop_capabilities_bounding_set_if_needed</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// -------------降权----------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="cm">/* then switch user and group to &#34;shell&#34; */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">setgid</span><span class="p">(</span><span class="n">AID_SHELL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">setuid</span><span class="p">(</span><span class="n">AID_SHELL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">D</span><span class="p">(</span><span class="s">&#34;Local port disabled</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="n">should_drop_privileges</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef ALLOW_ADBD_ROOT
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else </span><span class="cm">/* ALLOW_ADBD_ROOT */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="kt">int</span> <span class="n">secure</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">value</span><span class="p">[</span><span class="n">PROPERTY_VALUE_MAX</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="cm">/* run adbd in secure mode if ro.secure is set and
</span></span></span><span class="line"><span class="cl"><span class="cm">    ** we are not in the emulator
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="n">property_get</span><span class="p">(</span><span class="s">&#34;ro.kernel.qemu&#34;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&#34;1&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">property_get</span><span class="p">(</span><span class="s">&#34;ro.secure&#34;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="s">&#34;1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&#34;1&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// don&#39;t run as root if ro.secure is set...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">secure</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// ... except we allow running as root in userdebug builds if the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// service.adb.root property has been set by the &#34;adb root&#34; command
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">property_get</span><span class="p">(</span><span class="s">&#34;ro.debuggable&#34;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&#34;1&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">property_get</span><span class="p">(</span><span class="s">&#34;service.adb.root&#34;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&#34;1&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">secure</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">secure</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="cm">/* ALLOW_ADBD_ROOT */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="cm">/* !ADB_HOST */</span><span class="cp">
</span></span></span></code></pre></div><h3 id="b-adb连接时是否需要进行需要用户授权验证">B. adb连接时，是否需要进行需要用户授权验证</h3>
<p>相关Property: <code>ro.adb.secure</code></p>
<blockquote>
<p>允许USB调试吗？</p>
<p>这台计算机的RSA密钥指纹如下:
23:B2:47:E1:08:DE:5A:3B:58:5A:A5:A6:FA:98:E0:50</p>
<p>一律允许使用这台计算机进行调试</p>
</blockquote>
<ul>
<li>1: 需要授权</li>
<li>0: 不需要</li>
</ul>
<h3 id="c-adb的连接模式">C. adb的连接模式</h3>
<p>相关Property: <code>service.adb.tcp.port</code>、<code>persist.adb.tcp.port</code>
adbd以何种模式进行工作：</p>
<ul>
<li>为0: 以USB模式工作</li>
<li>不为0: 以TCP/IP模式工作, 并且此值作为监听端口</li>
</ul>
<p><strong>adb决定使用TCP/IP模式的逻辑：</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp"># 伪代码
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">if</span> <span class="p">(</span><span class="n">service</span><span class="p">.</span><span class="n">adb</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">port</span> <span class="o">!=</span> <span class="n">null</span> <span class="o">?</span> <span class="n">service</span><span class="p">.</span><span class="n">adb</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="nl">port</span> <span class="p">:</span> <span class="n">persist</span><span class="p">.</span><span class="n">adb</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">port</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cp"># it&#39;s tcp/ip mode.
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="p">}</span> 
</span></span></code></pre></div><p>以下是源码中选择模式的逻辑：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// xref: /system/core/adb/adb.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">adb_main</span><span class="p">(</span><span class="kt">int</span> <span class="n">is_daemon</span><span class="p">,</span> <span class="kt">int</span> <span class="n">server_port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="kt">int</span> <span class="n">usb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 当存在/dev/android_adb或/dev/usb-ffs/adb/ep0时, 先预设为USB模式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">USB_ADB_PATH</span><span class="p">,</span> <span class="n">F_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">access</span><span class="p">(</span><span class="n">USB_FFS_ADB_EP0</span><span class="p">,</span> <span class="n">F_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// listen on USB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">usb_init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">usb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 若port不为0，则使用TCP/IP模式，否则维持USB模式.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// If one of these properties is set, also listen on that port
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// If one of the properties isn&#39;t set and we couldn&#39;t listen on usb,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// listen on the default port.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">property_get</span><span class="p">(</span><span class="s">&#34;service.adb.tcp.port&#34;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">property_get</span><span class="p">(</span><span class="s">&#34;persist.adb.tcp.port&#34;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">port</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;using port=%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// listen on TCP port specified by service.adb.tcp.port property
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">local_init</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// listen on default port
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">local_init</span><span class="p">(</span><span class="n">DEFAULT_ADB_LOCAL_TRANSPORT_PORT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><h3 id="d-adbd-是否运行中">D. Adbd 是否运行中</h3>
<p>相关Property: <code>init.svc.adbd</code>
例子：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>init.svc.adbd<span class="o">]</span>: <span class="o">[</span>running<span class="o">]</span>
</span></span></code></pre></div><h3 id="e-adb是否被打开">E. Adb是否被打开</h3>
<p>相关Property: <code>sys.usb.state</code>
例子：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>sys.usb.state<span class="o">]</span>: <span class="o">[</span>mtp,adb<span class="o">]</span>
</span></span></code></pre></div><p>该项显示了usb上所有支持的功能，以逗号分割。如上如果adb打开，则会出现adb字样</p>
<h2 id="四adb的开启关闭">四、Adb的开启/关闭</h2>
<p>在Android中，当Mobile通过USB连接到PC后，到底开启哪些功能(如：adbd、midi、mtp等) 都是由<code>UsbDeviceManager</code>来做总控的。而<code>UsbDeviceManager</code>对这些功能控制的方式就是通过修改<code>property</code>。adbd会根据相关preoperty项作出相应操作，从而决定是否被打开。那么adbd是如何响应property的更改呢？ 这主要依赖<code>init.usb.rc</code>或<code>init.*.usb.rc</code>在一开机就注册好的property事件，当指定的property项如<code>sys.usb.config</code>的值被设为<code>mtp,usb</code>时，就会触发启动adbd的命令。</p>
<p><img src="3.png" alt="adb" title="adb"></p>
<p><strong>首先介绍打开adb的大体流程：</strong></p>
<ul>
<li>流程从Settings开始，在“开发者选项”中点击打开“USB调试”选项打开。</li>
<li>Settings将<code>Settings.Global.DEVELOPMENT_SETTINGS_ENABLED</code>配置更新到Preference，并最后调用回调广而告之。</li>
<li>此时运行于system_server进程中的UsbDeviceManager收到了ADB_ENABLE被修改的事件后，马上进行更新property: sys.usb.config的值，假如原value为“mtp”，更新完成后变为&quot;mtp, adb&quot;。</li>
<li>此时init.usb.rc进程收到property被修改的事件，立刻执行预设好的shell命令(如上图中的&quot;start adbd&quot;)。最后更新sys.usb.state的值，使之与sys.usb.state相同，表明所有任务已完成。</li>
</ul>
<p><strong>以下是UsbDeviceManager之后开始的详细代码流程：</strong></p>
<p>在Settings中，控制adb开关都是通过framework.jar中的<code>UsbManager::setCurrentFunction()</code>达成的，最后会通过Binder调用至system_server中的<code>UsbService::setCurrentFunction()</code>。</p>
<p><strong>1. 如果此时adb已为开启状态，就认为本次的调用目的是为了关闭adb()。如果为关闭状态，就认为本次是为了打开adb:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">xref:</span> <span class="o">/</span><span class="n">frameworks</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">usb</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">server</span><span class="o">/</span><span class="n">usb</span><span class="o">/</span><span class="n">UsbDeviceManager</span><span class="o">.</span><span class="na">java</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setEnabledFunctions</span><span class="o">(</span><span class="n">String</span> <span class="n">functions</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">makeDefault</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">mAdbEnabled</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">functions</span> <span class="o">=</span> <span class="n">addFunction</span><span class="o">(</span><span class="n">functions</span><span class="o">,</span> <span class="n">UsbManager</span><span class="o">.</span><span class="na">USB_FUNCTION_ADB</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">functions</span> <span class="o">=</span> <span class="n">removeFunction</span><span class="o">(</span><span class="n">functions</span><span class="o">,</span> <span class="n">UsbManager</span><span class="o">.</span><span class="na">USB_FUNCTION_ADB</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span></code></pre></div><p><strong>2. 假设目前为打开adb操作，在<code>sys.usb.config</code>值的尾部拼接&quot;,adb&quot;，并更新该property值:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// xref: /frameworks/base/services/usb/java/com/android/server/usb/UsbDeviceManager.java
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">addFunction</span><span class="o">(</span><span class="n">String</span> <span class="n">functions</span><span class="o">,</span> <span class="n">String</span> <span class="n">function</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="o">(</span><span class="s">&#34;none&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">functions</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">             <span class="k">return</span> <span class="n">function</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">         <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">containsFunction</span><span class="o">(</span><span class="n">functions</span><span class="o">,</span> <span class="n">function</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">functions</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">functions</span> <span class="o">+=</span> <span class="s">&#34;,&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">functions</span> <span class="o">+=</span> <span class="n">function</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">functions</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p><strong>3. 然后开启线程，循环每隔50ms监控<code>sys.usb.state</code>的值是否与<code>sys.usb.config</code>相等了。(如果相等表明property修改的事件被成功响应了):</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// xref: /frameworks/base/services/usb/java/com/android/server/usb/UsbDeviceManager.java
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">waitForState</span><span class="o">(</span><span class="n">String</span> <span class="n">state</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// wait for the transition to complete.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// give up after 1 second.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">20</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// State transition is done when sys.usb.state is set to the new configuration
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">SystemProperties</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;sys.usb.state&#34;</span><span class="o">)))</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">SystemClock</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">50</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;waitForState(&#34;</span> <span class="o">+</span> <span class="n">state</span> <span class="o">+</span> <span class="s">&#34;) FAILED&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span></code></pre></div><p><strong>4. 然后流程来到<code>init.*.usb.rc</code>中:</strong></p>
<p>以下的脚本片段为其中的一段，大致含义之当property<code>sys.usb.config</code>的值为<code>&quot;mtp,adb&quot;</code>时，触发以下块内的脚本</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">on property:sys.usb.config<span class="o">=</span>mtp,adb
</span></span><span class="line"><span class="cl">    write /sys/class/android_usb/android0/enable <span class="m">0</span>
</span></span><span class="line"><span class="cl">    write /sys/class/android_usb/android0/idVendor 18D1  <span class="c1"># 设置厂商ID，以便PC端可以正常识别</span>
</span></span><span class="line"><span class="cl">    write /sys/class/android_usb/android0/idProduct 4EE2 
</span></span><span class="line"><span class="cl">    write /sys/class/android_usb/android0/bDeviceClass <span class="m">0</span>
</span></span><span class="line"><span class="cl">    write /sys/class/android_usb/android0/bDeviceSubClass <span class="m">0</span>
</span></span><span class="line"><span class="cl">    write /sys/class/android_usb/android0/bDeviceProtocol <span class="m">0</span>
</span></span><span class="line"><span class="cl">    write /sys/class/android_usb/android0/functions mtp,adb
</span></span><span class="line"><span class="cl">    write /sys/class/android_usb/android0/enable <span class="m">1</span>
</span></span><span class="line"><span class="cl">    start adbd  <span class="c1"># 启动adbd</span>
</span></span><span class="line"><span class="cl">    setprop sys.usb.state <span class="si">${</span><span class="nv">sys</span><span class="p">.usb.config</span><span class="si">}</span>  <span class="c1"># 最后更新当前usb的状态值</span>
</span></span></code></pre></div><p>以上就是adb的开关原理，主要是依赖于init脚本的事件来实现。</p>
<h2 id="五adbd-与-server-的授权过程">五、Adbd 与 Server 的授权过程</h2>
<p><img src="4.png" alt="adb" title="adb"></p>
<ul>
<li>
<p>当Mobile插入PC后，双方检测到Adb连接发生：</p>
</li>
<li>
<p>1.Mobile向PC发送随机<code>AUTH TOKEN</code></p>
</li>
<li>
<p>2.PC收到<code>AUTH TOKEN</code>后使用私钥(<code>~/.android/adbkey</code>)对Token计算<code>SIGNATURE</code>, 并计算Tokne的SHA-1，将结果发回Mobile.</p>
</li>
</ul>
<p><img src="5.png" alt="adb" title="adb"></p>
<ul>
<li>3.Mobile根据PC名检查是否<code>保存过/授权过</code>PC的公钥(从<code>/data/misc/adb/adb_keys</code>中读取已保存的授权)。如果已授权过，流程直接跳到第7步。否则到下一步进行新授权.</li>
</ul>
<p><img src="6.png" alt="adb" title="adb"></p>
<ul>
<li>4.Mobile发送<code>UNAUTHORIZED</code>到PC</li>
<li>5.PC收到<code>UNAUTHORIZED</code>后将<code>RSA PUBLICKEY</code>(<code>~/.android/adbkey.pub</code>)发往Mobile</li>
<li>6.Mobile收到新的<code>RSA PUBLICKEY</code>后计算HASH，并弹出<code>允许USB调试吗？</code>的对话框请求用户允许，进行下一步，否则流程终止/连接失败</li>
<li>7.Mobile向PC发送<code>ONLINE</code>状态，双方授权验证完成，连接成功</li>
</ul>
<p><img src="7.png" alt="adb" title="adb"></p>
<p><img src="8.png" alt="adb" title="adb"></p>
<h2 id="六pc端adb-server流程">六、PC端Adb Server流程</h2>
<ul>
<li>Adb Server在首次调用Adb命令的时候被启动， Adb Client与Adb Server共用一个binary文件，由参数区分角色(Client/Server)。</li>
<li>Adb Server由Adb Client通过命令<code>adb -P 5037 fork-server server</code>进行启动(默认的Adb Server监听端口为5037)。</li>
</ul>
<h3 id="a-adb-server-启动流程">A. Adb Server 启动流程</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// xref: /system/core/adb/commandline.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">adb_main</span><span class="p">(</span><span class="kt">int</span> <span class="n">is_daemon</span><span class="p">,</span> <span class="kt">int</span> <span class="n">server_port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#if ADB_HOST
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>   <span class="c1">// 在PC上运行的ADB流程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">usb_vendors_init</span><span class="p">();</span>   <span class="c1">// 初始化各手机厂商的vendor id号， 以便adb能从已插入的usb设备中识别出手机
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">usb_init</span><span class="p">();</span>  <span class="c1">// 开启对usb设备的监控(每隔1ms遍历一次/dev/bus/usb)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">local_init</span><span class="p">(</span><span class="n">DEFAULT_ADB_LOCAL_TRANSPORT_PORT</span><span class="p">);</span>  <span class="c1">// 首次尝试连接本地的Android模拟器(向localhost:5555端口发起链接)， #define DEFAULT_ADB_LOCAL_TRANSPORT_PORT 5555
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">adb_auth_init</span><span class="p">();</span>  <span class="c1">// 初始化公钥文件，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">local_name</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">build_local_name</span><span class="p">(</span><span class="n">local_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">local_name</span><span class="p">),</span> <span class="n">server_port</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">install_listener</span><span class="p">(</span><span class="n">local_name</span><span class="p">,</span> <span class="s">&#34;*smartsocket*&#34;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>   <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>1. 初始化各厂商手机的USB的Vender ID号，除了内置了一批常见ID外，还会从<code>~/.android/adb_usb.ini</code>读取，以便用户添加不常见的设备。</strong></p>
<p>如下， 内置的一批Vendor ID</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// xref: /system/core/adb/usb_vendors.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cm">/* Keep the list below sorted alphabetically by #define name */</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Acer&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_ACER          0x0502
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Allwinner&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_ALLWINNER     0x1F3A
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Amlogic&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_AMLOGIC       0x1b8e
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// AnyDATA&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_ANYDATA       0x16D5
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Archos&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_ARCHOS        0x0E79
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Asus&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_ASUS          0x0b05
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// BYD&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_BYD           0x1D91
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Compal&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_COMPAL        0x04B7
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Compalcomm&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_COMPALCOMM    0x1219
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Dell&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_DELL          0x413c
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// ECS&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_ECS           0x03fc
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// EMERGING_TECH&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_EMERGING_TECH 0x297F
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Emerson&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_EMERSON       0x2207
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Foxconn&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_FOXCONN       0x0489
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Fujitsu&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_FUJITSU       0x04C5
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Funai&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_FUNAI         0x0F1C
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Garmin-Asus&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_GARMIN_ASUS   0x091E
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Gigabyte&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_GIGABYTE      0x0414
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Gigaset&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_GIGASET       0x1E85
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// GIONEE&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_GIONEE        0x271D
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Google&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_GOOGLE        0x18d1
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Haier&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_HAIER         0x201E
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Harris&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_HARRIS        0x19A5
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Hisense&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_HISENSE       0x109b
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Honeywell&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_HONEYWELL     0x0c2e
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// HP&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_HP            0x03f0
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// HTC&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_HTC           0x0bb4
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Huawei&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_HUAWEI        0x12D1
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// INQ Mobile&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_INQ_MOBILE    0x2314
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Intel&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_INTEL         0x8087
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Intermec&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_INTERMEC      0x067e
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// IRiver&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_IRIVER        0x2420
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// K-Touch&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_K_TOUCH       0x24E3
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// KT Tech&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_KT_TECH       0x2116
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Kobo&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_KOBO          0x2237
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Kyocera&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_KYOCERA       0x0482
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Lab126&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_LAB126        0x1949
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Lenovo&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_LENOVO        0x17EF
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// LenovoMobile&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_LENOVOMOBILE  0x2006
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// LG&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_LGE           0x1004
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Lumigon&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_LUMIGON       0x25E3
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Motorola&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_MOTOROLA      0x22b8
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// MSI&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_MSI           0x0DB0
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// MTK&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_MTK           0x0e8d
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// NEC&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_NEC           0x0409
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// B&amp;N Nook&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_NOOK          0x2080
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Nvidia&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_NVIDIA        0x0955
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// OPPO&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_OPPO          0x22D9
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// On-The-Go-Video&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_OTGV          0x2257
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// OUYA&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_OUYA          0x2836
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Pantech&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_PANTECH       0x10A9
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Pegatron&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_PEGATRON      0x1D4D
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Philips&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_PHILIPS       0x0471
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Panasonic Mobile Communication&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_PMC           0x04DA
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Positivo&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_POSITIVO      0x1662
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Prestigio&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_PRESTIGIO     0x29e4
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Qisda&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_QISDA         0x1D45
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Qualcomm&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_QUALCOMM      0x05c6
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Quanta&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_QUANTA        0x0408
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Rockchip&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_ROCKCHIP      0x2207
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Samsung&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_SAMSUNG       0x04e8
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Sharp&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_SHARP         0x04dd
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// SK Telesys&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_SK_TELESYS    0x1F53
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Smartisan&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_SMARTISAN     0x29a9
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Sony&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_SONY          0x054C
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Sony Ericsson&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_SONY_ERICSSON 0x0FCE
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// T &amp; A Mobile Phones&#39; USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_T_AND_A       0x1BBB
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// TechFaith&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_TECHFAITH     0x1d09
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Teleepoch&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_TELEEPOCH     0x2340
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Texas Instruments&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_TI            0x0451
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Toshiba&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_TOSHIBA       0x0930
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Unowhy&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_UNOWHY        0x2A49
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Vizio&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_VIZIO         0xE040
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Wacom&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_WACOM         0x0531
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Xiaomi&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_XIAOMI        0x2717
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// YotaDevices&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_YOTADEVICES   0x2916
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Yulong Coolpad&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_YULONG_COOLPAD 0x1EBF
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// ZTE&#39;s USB Vendor ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define VENDOR_ID_ZTE           0x19D2
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="cm">/* Keep the list above sorted alphabetically by #define name */</span>
</span></span></code></pre></div><p><strong>2. 启动新线程，监控usb中出现的手机：</strong></p>
<p>每隔1秒，从/dev/bus/usb扫描一次新增的USB设备.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// xref: /system/core/adb/usb_linux.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span><span class="o">*</span> <span class="nf">device_poll_thread</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">unused</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">D</span><span class="p">(</span><span class="s">&#34;Created device thread</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* XXX use inotify */</span>
</span></span><span class="line"><span class="cl">        <span class="n">find_usb_device</span><span class="p">(</span><span class="s">&#34;/dev/bus/usb&#34;</span><span class="p">,</span> <span class="n">register_device</span><span class="p">);</span>  <span class="c1">//每隔1秒， 扫描一次新增USB设备
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">kick_disconnected_devices</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">find_usb_device</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">register_device_callback</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">busname</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="n">devname</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">local_ep_in</span><span class="p">,</span> <span class="n">local_ep_out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DIR</span> <span class="o">*</span><span class="n">busdir</span> <span class="p">,</span> <span class="o">*</span><span class="n">devdir</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">dirent</span> <span class="o">*</span><span class="n">de</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fd</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">busdir</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">busdir</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">readdir</span><span class="p">(</span><span class="n">busdir</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">badname</span><span class="p">(</span><span class="n">de</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">snprintf</span><span class="p">(</span><span class="n">busname</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">busname</span><span class="p">,</span> <span class="s">&#34;%s/%s&#34;</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">de</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">devdir</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">busname</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">devdir</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//        DBGX(&#34;[ scanning %s ]\n&#34;, busname);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">readdir</span><span class="p">(</span><span class="n">devdir</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">devdesc</span><span class="p">[</span><span class="mi">4096</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">bufptr</span> <span class="o">=</span> <span class="n">devdesc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">bufend</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">usb_device_descriptor</span><span class="o">*</span> <span class="n">device</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">usb_config_descriptor</span><span class="o">*</span> <span class="n">config</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">usb_interface_descriptor</span><span class="o">*</span> <span class="n">interface</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">ep1</span><span class="p">,</span> <span class="o">*</span><span class="n">ep2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">unsigned</span> <span class="n">zero_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">unsigned</span> <span class="n">vid</span><span class="p">,</span> <span class="n">pid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">size_t</span> <span class="n">desclength</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p><strong>3、初始化adb的public key，以便后续与手机进行授权握手：</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// xref: /system/core/adb/adb_auth_host.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">get_user_keyfilepath</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="o">*</span><span class="n">home</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">android_dir</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">stat</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef _WIN32
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">home</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&#34;ANDROID_SDK_HOME&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">home</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SHGetFolderPath</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">CSIDL_PROFILE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">home</span> <span class="o">=</span> <span class="n">path</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">format</span> <span class="o">=</span> <span class="s">&#34;%s</span><span class="se">\\</span><span class="s">%s&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="n">home</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&#34;HOME&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">home</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">format</span> <span class="o">=</span> <span class="s">&#34;%s/%s&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">    <span class="n">D</span><span class="p">(</span><span class="s">&#34;home &#39;%s&#39;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">home</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">snprintf</span><span class="p">(</span><span class="n">android_dir</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">android_dir</span><span class="p">),</span> <span class="n">format</span><span class="p">,</span> <span class="n">home</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">ANDROID_PATH</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">android_dir</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">(</span><span class="n">android_dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">adb_mkdir</span><span class="p">(</span><span class="n">android_dir</span><span class="p">,</span> <span class="mo">0750</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">D</span><span class="p">(</span><span class="s">&#34;Cannot mkdir &#39;%s&#39;&#34;</span><span class="p">,</span> <span class="n">android_dir</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 拼接得出～/.android/adbkey
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">android_dir</span><span class="p">,</span> <span class="n">ADB_KEY_FILE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>4、开启socket并开启事件循环，接受Client连接和发来的命令.</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// xref: /system/core/adb/fdevent.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">fdevent_loop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">fdevent</span> <span class="o">*</span><span class="n">fde</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">fdevent_subproc_setup</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">D</span><span class="p">(</span><span class="s">&#34;--- ---- waiting for events</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">fdevent_process</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">while</span><span class="p">((</span><span class="n">fde</span> <span class="o">=</span> <span class="n">fdevent_plist_dequeue</span><span class="p">()))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">fdevent_call_fdfunc</span><span class="p">(</span><span class="n">fde</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="七mobile端adbd流程">七、Mobile端Adbd流程</h2>
<p><strong>1. adbd是由init进程启动，启动方式在init.rc中定义：</strong></p>
<ul>
<li>首先init会帮忙创建一个名为adbd的unix socket(system system)</li>
<li>然后启动adbd进程，并且将上面的socket传给adbd进程</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">// xref: init.rc
</span></span><span class="line"><span class="cl">service adbd /sbin/adbd --root_seclabel<span class="o">=</span>u:r:su:s0 --device_banner<span class="o">=</span>recovery
</span></span><span class="line"><span class="cl">    disabled
</span></span><span class="line"><span class="cl">    socket adbd stream <span class="m">660</span> system system 
</span></span><span class="line"><span class="cl">    seclabel u:r:adbd:s0
</span></span></code></pre></div><p><strong>2. adbd启动后，读取<code>ro.adb.secure</code>，决定是否要求PC进行PublicKey+Token认证.</strong></p>
<ul>
<li>为1表示需要认证后，才能建立连接</li>
<li>为0表示不需要认证，直接可以建立链接</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// xref: /system/core/adb/adb.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">adb_main</span><span class="p">(</span><span class="kt">int</span> <span class="n">is_daemon</span><span class="p">,</span> <span class="kt">int</span> <span class="n">server_port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">property_get</span><span class="p">(</span><span class="s">&#34;ro.adb.secure&#34;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="s">&#34;0&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">auth_enabled</span> <span class="o">=</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&#34;1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">auth_enabled</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">adb_auth_init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p><strong>3. 读取<code>ro.secure</code>，决定是否需要将自身进程降权到SHELL权限(adbd以root权限启动)</strong></p>
<ul>
<li>为1, 降权到SHELL权限</li>
<li>为0, 不需要降权</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// xref: /system/core/adb/adb.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">adb_main</span><span class="p">(</span><span class="kt">int</span> <span class="n">is_daemon</span><span class="p">,</span> <span class="kt">int</span> <span class="n">server_port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* don&#39;t listen on a port (default 5037) if running in secure mode */</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* don&#39;t run as root if we are running in secure mode */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">should_drop_privileges</span><span class="p">())</span> <span class="p">{</span>    <span class="c1">// 内部依据`ro.secure`
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">drop_capabilities_bounding_set_if_needed</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* then switch user and group to &#34;shell&#34; */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">setgid</span><span class="p">(</span><span class="n">AID_SHELL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">setuid</span><span class="p">(</span><span class="n">AID_SHELL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">D</span><span class="p">(</span><span class="s">&#34;Local port disabled</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p><strong>4. 开启线程监控 <code>/dev/android_adb</code>或<code>/dev/usb-ffs/adb/ep0</code> , 监控adb的连接：</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// xref: /system/core/adb/usb_linux_client.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">usb_adb_open_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">usb_handle</span> <span class="o">*</span><span class="n">usb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_handle</span> <span class="o">*</span><span class="p">)</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// wait until the USB device needs opening
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">adb_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">adb_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">adb_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">D</span><span class="p">(</span><span class="s">&#34;[ usb_thread - opening device ]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* XXX use inotify? */</span>
</span></span><span class="line"><span class="cl">            <span class="n">fd</span> <span class="o">=</span> <span class="n">unix_open</span><span class="p">(</span><span class="s">&#34;/dev/android_adb&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>  <span class="c1">// 尝试打开，如果成功，认为adb被连接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// to support older kernels
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">fd</span> <span class="o">=</span> <span class="n">unix_open</span><span class="p">(</span><span class="s">&#34;/dev/android&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">adb_sleep_ms</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">D</span><span class="p">(</span><span class="s">&#34;[ opening device succeeded ]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">close_on_exec</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">usb</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">D</span><span class="p">(</span><span class="s">&#34;[ usb_thread - registering device ]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">register_usb_transport</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// never gets here
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>5. 检查service.adb.tcp.port， 是否需要开启TCP/IP连接模式：</strong></p>
<ul>
<li>不为0, 则开启TCP/IP模式，并且以此值作为监听的端口号.</li>
<li>为0, 则不开启.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// xref: /system/core/adb/adb.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">adb_main</span><span class="p">(</span><span class="kt">int</span> <span class="n">is_daemon</span><span class="p">,</span> <span class="kt">int</span> <span class="n">server_port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// If one of these properties is set, also listen on that port
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// If one of the properties isn&#39;t set and we couldn&#39;t listen on usb,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// listen on the default port.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">property_get</span><span class="p">(</span><span class="s">&#34;service.adb.tcp.port&#34;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">property_get</span><span class="p">(</span><span class="s">&#34;persist.adb.tcp.port&#34;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">port</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;using port=%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// listen on TCP port specified by service.adb.tcp.port property
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">local_init</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>  <span class="c1">// 开启TCP/IP模式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// listen on default port
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">local_init</span><span class="p">(</span><span class="n">DEFAULT_ADB_LOCAL_TRANSPORT_PORT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p><strong>6、开启socket并开启事件循环，接受Client连接和发来的命令.</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// xref: /system/core/adb/fdevent.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">fdevent_loop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">fdevent</span> <span class="o">*</span><span class="n">fde</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">fdevent_subproc_setup</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">D</span><span class="p">(</span><span class="s">&#34;--- ---- waiting for events</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">fdevent_process</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">while</span><span class="p">((</span><span class="n">fde</span> <span class="o">=</span> <span class="n">fdevent_plist_dequeue</span><span class="p">()))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">fdevent_call_fdfunc</span><span class="p">(</span><span class="n">fde</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="八总结">八、总结</h2>
<p>总而言之，Adb就是为了方便Host与目标Android设备通讯而出现的一种套件。 USB与TCP/IP只是其通讯的一种方式。另外本文没有阐述的forward与jdwp的通讯本质就是一种TCP代理，所以没有涉及。另外根据本次分析过程里意外得到的灵感中还衍生出几个Adb定制的项目，作为本次分析的#TODO，便于以后的adb封紧及双域分析的分析。</p>
<h2 id="九faq">九、FAQ</h2>
<h3 id="1-如何使用tcpip模式连接adb">1. 如何使用TCP/IP模式连接ADB</h3>
<p>使用TCP/IP模式的方法分为两种：</p>
<p><strong>第一种</strong> 连接adb后在PC上切换</p>
<p>详见上文中<code>二、基本用法</code>中的<code>A. 切换为TCP/IP模式</code></p>
<p><strong>第二种</strong> 使设备天然支持TCP/IP模式</p>
<p>详见上文中<code>三、Android中跟Adb相关的property</code>中的<code>C. adb的连接模式</code></p>
<h3 id="2-如何让adb不验证公钥证书而允许所有pc直接连接">2. 如何让adb不验证公钥证书而允许所有PC直接连接</h3>
<p>详见上问中<code>三、Android中跟Adb相关的property</code>中的<code>adb连接时，是否需要进行需要用户授权验证</code></p>
<h3 id="3-如何让adb只允许指定的机器publickey连接">3. 如何让adb只允许指定的<code>机器/PublicKey</code>连接</h3>
<p>目前没有发现可直接通过property或其他Config配置的方法，但可以通过<code>修改代码</code>+<code>增加配置</code>实现：</p>
<p><strong>1. 禁止询问用户<code>调试授权</code>：</strong></p>
<p>调试授权：adb原生逻辑中，当TOKEN验证失败后，PC会重发PUBLICKEY给Mobile，尝试重新建立授权。
对代码修改，不再允许<code>申请调试授权</code>！</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// xref: /system/core/adb/adb.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">handle_packet</span><span class="p">(</span><span class="n">apacket</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">atransport</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">asocket</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">case</span> <span class="nl">A_AUTH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">arg0</span> <span class="o">==</span> <span class="n">ADB_AUTH_TOKEN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="o">-&gt;</span><span class="n">connection_state</span> <span class="o">=</span> <span class="n">CS_UNAUTHORIZED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">adb_auth_nextkey</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">send_auth_response</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">data_length</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/* No more private keys to try, send the public key */</span>
</span></span><span class="line"><span class="cl">                <span class="n">send_auth_publickey</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">arg0</span> <span class="o">==</span> <span class="n">ADB_AUTH_SIGNATURE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">adb_auth_verify</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">data_length</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">adb_auth_verified</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">t</span><span class="o">-&gt;</span><span class="n">failed_auth_attempts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">failed_auth_attempts</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">adb_sleep_ms</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">send_auth_request</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">arg0</span> <span class="o">==</span> <span class="n">ADB_AUTH_RSAPUBLICKEY</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">adb_auth_confirm_key</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">data_length</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>  <span class="c1">// 此处为收到PC发来的PUBLICKEY，对其计算后向用户询问是否同意授权(弹出：允许USB调试吗？)。所以注释掉此处代码。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">put_apacket</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>2. 在<code>/data/misc/adb/adb_keys</code>中只保留允许连接的PC的PublicKey</strong></p>
<pre tabindex="0"><code></code></pre><p><strong>3. 最后确保<code>ro.adb.secure</code>为1</strong></p>
<h3 id="4-禁用adb的各种思路">4. 禁用Adb的各种思路</h3>
<p>关于adb的开启/关闭原理可以通过<code>五、adb的开启/关闭</code>了解，从该节可以了解到，adb的开启关闭最终依赖<code>init脚本</code>中的事件功能来实现。
沿着这条流程，可以生出很多种禁掉adb的方式，下面就一一列举几条(只提供思路)：</p>
<ol>
<li>对Settings做定制，在程序启动时直接调用<code>Settings.Global.putInt(getContentResolver(), Settings.Global.ADB_ENABLED, 0); </code>来关闭ADB(最终实现还是通过设置<code>sys.usb.config</code>)</li>
<li>对<code>UsbDeviceManager::addFunction()</code>做修改，当参数<code>functions</code>为“adb”时，就直接返回，不进行下一步操作(不对property做修改)。</li>
<li>修改<code>init.*.usb.rc</code>脚本，将其中包含adb条件的块删除，或做修改，使其不再对property值的变更作出响应。</li>
<li>&hellip;.</li>
</ol>
<h3 id="5-如何让多人访问一台设备">5. 如何让多人访问一台设备</h3>
<p>首先在USB连接了手机的电脑上开启service：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">adb nodaemon server -a  <span class="c1"># -a 表示监听所有来路</span>
</span></span></code></pre></div><p>然后在其他电脑上，指定host来执行命令即可：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">adb -H 192.168.128.228 devices
</span></span></code></pre></div><h2 id="十结语">十、结语</h2>
<p>adb作为android系统的原生调试工具极大方便了开发者的调试，其生于android但并不专属于android。
得益于adb的优秀的跨平台能力和与系统低耦合的特性，其被移植到了很多基于unix、linux系统的IoT设备，也被安全定制后放入很多特种设备(不允许外部连接)，但由于系统开发人员对于adb了解不透彻、缺乏安全意识造成了很多的安全风险。在我进行的诸多安全服务项目中，由于adb阉割不完全或保护不当，最终导致各类保密设备、特种设备被攻破的案例屡见不鲜，所以作为一名合格的系统开发人员，完整掌握adb架构和实现绝对是必不可少的。</p>

    </div>
    <div class="post-footer">
      <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "pkiller" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  </article>

    </main>
  </body>
</html>
